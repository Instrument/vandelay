{% extends "_layouts/cp" %}
{% set centered = true %}
{% set title = 'SimpleApi' %}
{% set sections = craft.sections.getAllSections() %}
{% set handles = [] %}
{% set js %}
  $('.trigger').on('click', function() {
    $('[id^=section-]').text('exporting');
    {% for section in sections %}
      $.get( "/simpleapi/getSection/{{ section.handle }}?download=1", function( data ) {
        var filename = '{{section.handle}}-{{craft.locale}}';
        var blob = new Blob([JSON.stringify(data)], {type: "application/json;charset=utf-8"});
        saveAs(blob, filename+".json");
        $('#section-{{section.handle}}').text('exported');
      });
    {% endfor %}
    $.get( "/actions/simpleApi/getGlobals", function( data ) {
        var filename = data.title + '-' + data.locale;
        var blob = new Blob([JSON.stringify(data)], {type: "application/json;charset=utf-8"});
        saveAs(blob, filename+".json");
        $('#globals').text('exported');
    });
  })
{% endset %}
{% set css %}
  td {
    padding: 10px 20px 10px 0px;
  }
{% endset %}
{% includeCss css %}
{% set content %}
    <button class="trigger">Export sections</button>
    <h2>All Sections</h2>
    <table>
      <thead>
      <tr>
        <th>Section</th>
      </tr>
      </thead>
      <tbody>
        {% for section in sections %}
        <tr>
          <td>{{ section.name }}</td>
          <td id="section-{{section.handle}}">
            Not exported
          </td>
        </tr>
      {% endfor %}
      <tr>
        <td>Globals</td>
        <td id="globals">
          Not exported
        </td>
      </tr>
      </tbody>
    </table>
{% endset %}
{% includeJsResource 'simpleApi/js/fetch.js' %}
{% includeJs js %}