{% extends "_layouts/cp" %}
{% set centered = true %}
{% set title = 'SimpleApi' %}
{% set sections = craft.sections.getAllSections() %}
{% set categories = craft.categories.getAllCategories() %}
{% set locales = craft.i18n.getSiteLocaleIds()%}
{% set handles = [] %}
{% set css %}
  td, th {
    padding: 10px 20px 10px 0px;
  }
  .green {
    color: green;
  }
  .red {
    color: red;
  }
  .box__dragndrop,
  .box__uploading,
  .box__success,
  .box__error {
    display: none;
  }
  .fa-spinner{
    animation: animationFrames linear 1s;
    animation-iteration-count: infinite;
    transform-origin: 50% 50%;
    animation-fill-mode:forwards; /*when the spec is finished*/
    -webkit-animation: animationFrames linear 1s;
    -webkit-animation-iteration-count: infinite;
    -webkit-transform-origin: 50% 50%;
    -webkit-animation-fill-mode:forwards; /*Chrome 16+, Safari 4+*/ 
    -moz-animation: animationFrames linear 1s;
    -moz-animation-iteration-count: infinite;
    -moz-transform-origin: 50% 50%;
    -moz-animation-fill-mode:forwards; /*FF 5+*/
    -o-animation: animationFrames linear 1s;
    -o-animation-iteration-count: infinite;
    -o-transform-origin: 50% 50%;
    -o-animation-fill-mode:forwards; /*Not implemented yet*/
    -ms-animation: animationFrames linear 1s;
    -ms-animation-iteration-count: infinite;
    -ms-transform-origin: 50% 50%;
    -ms-animation-fill-mode:forwards; /*IE 10+*/
  }

  @keyframes animationFrames{
    0% {
      transform:  rotate(0deg) ;
    }
    100% {
      transform:  rotate(360deg) ;
    }
  }

  @-moz-keyframes animationFrames{
    0% {
      -moz-transform:  rotate(0deg) ;
    }
    100% {
      -moz-transform:  rotate(360deg) ;
    }
  }

  @-webkit-keyframes animationFrames {
    0% {
      -webkit-transform:  rotate(0deg) ;
    }
    100% {
      -webkit-transform:  rotate(360deg) ;
    }
  }

  @-o-keyframes animationFrames {
    0% {
      -o-transform:  rotate(0deg) ;
    }
    100% {
      -o-transform:  rotate(360deg) ;
    }
  }

  @-ms-keyframes animationFrames {
    0% {
      -ms-transform:  rotate(0deg) ;
    }
    100% {
      -ms-transform:  rotate(360deg) ;
    }
  }
{% endset %}
{% includeCssFile 'https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' %}
{% includeCss css %}
{% set content %}
    <button class="trigger">Export sections</button>
    <h2>All Sections</h2>
    <table>
      <thead>
      <tr>
        <th>Section</th>
        <th>Status</th>
        {% for locale in locales %}
            <th>{{ locale }}</th>
        {% endfor %}
      </tr>
      </thead>
      <tbody>
        {% for section in sections %}
        <tr>
          <td>{{ section.name }}</td>
          <td id="section-{{section.handle}}">
            Not exported
          </td>
          {% set sectionLocales = section.getLocales() %}
           {% for locale in locales %}
              <td class="{{ locale in sectionLocales|keys ? 'green' : 'red'}}">
                <span class="fa {{ locale in sectionLocales|keys ? 'fa-check' : 'fa-close'}}"></span>
              </td>
           {% endfor %}
        </tr>
      {% endfor %}
      <tr>
        <td>Globals</td>
        <td id="globals">
          Not exported
        </td>
         {% for locale in locales %}
            <td class="green">
              <span class="fa fa-check"></span>
            </td>
         {% endfor %}
      </tr>
      </tbody>
    </table>
    <h2>Categories</h2>
    <table>
      <thead>
      <tr>
        <th>Category</th>
        <th>Status</th>
        {% for locale in locales %}
            <th>{{ locale }}</th>
        {% endfor %}
      </tr>
      </thead>
      <tbody>
        {% for category in categories %}
        <tr>
          <td>{{ category.title }}</td>
          <td id="cat-{{ category.id }}">
            Not exported
          </td>
          {% set catLocales = category.getLocales() %}
           {% for locale in locales %}
              <td class="{{ locale in catLocales|keys ? 'green' : 'red'}}">
                <span class="fa {{ locale in catLocales|keys ? 'fa-check' : 'fa-close'}}"></span>
              </td>
           {% endfor %}
        </tr>
      {% endfor %}
      
      </tbody>
    </table>
    <h2>Import localized files</h2>
    <form class="box" method="post" action="/actions/simpleApi/uploadEntry" enctype="multipart/form-data">
      <div class="box__input">
        <input class="box__file" type="file" name="files[]" id="file" data-multiple-caption="{count} files selected" multiple />
        <label for="file"><strong>Choose a file</strong><span class="box__dragndrop"> or drag it here</span>.</label>
        <button class="box__button" type="submit">Upload</button>
      </div>
      <br/>
      <div class="box__uploading">Uploading&hellip;</div>
      <div class="box__success">Done!</div>
      <div class="box__error">Error! <span></span>.</div>
    </form>
{% endset %}
{% includeJsFile 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/14082/FileSaver.js' %}
{% set js %}
$('.trigger').on('click', function() {
    $('[id^=section-]').html('<span class="fa fa-spinner"></span>');
    $('[id^=cat-]').html('<span class="fa fa-spinner"></span>');
    $('#globals').html('<span class="fa fa-spinner"></span>');
    {% for section in sections %}
      $.get( "/simpleapi/getSection/{{ section.handle }}?download=1", function( data ) {
        var filename = '{{section.handle}}-{{craft.locale}}';
        var blob = new Blob([JSON.stringify(data)], {type: "application/json;charset=utf-8"});
        saveAs(blob, filename+".json");
        $('#section-{{section.handle}}').text('exported');
      });
    {% endfor %}
    $.get( "/actions/simpleApi/getGlobals", function( data ) {
        var filename = data.title + '-' + data.locale;
        var blob = new Blob([JSON.stringify(data)], {type: "application/json;charset=utf-8"});
        saveAs(blob, filename+".json");
        $('#globals').text('exported');
    });
    $.get( "/actions/simpleApi/getCategories", function( data ) {
      var filename = 'categories-{{craft.locale}}';
      var blob = new Blob([JSON.stringify(data)], {type: "application/json;charset=utf-8"});
      saveAs(blob, filename+".json");
      {% for cat in categories %}
        $('#cat-{{ cat.id }}').text('exported');
      {% endfor %}
    });
  });
  var $form = $('form');
  var droppedFiles = false;
  var name;
  var fileSelect = document.getElementById('file');
  $form.on('submit', function (e) {
    e.preventDefault();
    $('.box__uploading').css('display', 'block');
    $('.box__success').css('display', 'none');
    var ajaxData = new FormData();
    var files = fileSelect.files;
    for (var i = 0, f; f = files[i]; i++) {
      var file = files[i];
      var reader = new FileReader();
      reader.onload = (function(theFile) {
        var file = theFile.name;
        var regex = /(..\_..)+/gi;
        var m = file.match(regex);
        
        file.replace(regex, function(match, g1, g2) { 
          name = g1.toLowerCase();
        });
        return function(e) {
          var p = JSON.parse(e.target.result);
          p.locale = name;
          if (p[0]) {
            [].slice.call(p).forEach(function(item) {
              item.locale = name;
            });
          }
          $.post({
            url: $form.attr('action'),
            dataType: 'json',
            contentType: 'application/json; charset=UTF-8',
            processData: false,
            data: JSON.stringify(p),
            success: function(data) {
              if (data.status == 200) {
                $('.box__uploading').css('display', 'none');
                $('.box__success').css('display', 'block');
                console.log(data);
              } else {
                console.log('error', data);
              }
            },
          });
        };
      })(f);
      reader.readAsText(f);
    }
  })
{% endset %}
{% includeJs js %}